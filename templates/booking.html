{% extends "base.html" %}
{% block title %}Book Appointment{% endblock %}
{% block content_class %}centered{% endblock %}
{% block content %}

<div class="booking-container">
    <header class="booking-header">
        <h1>Book Your Appointment</h1>
        <p>Select your specialization, doctor, and available time slot.</p>
    </header>

    <form action="/booking" method="POST" style="max-width: 500px; margin: auto;">
        
        <!-- Specialization -->
        <label for="specialization">Specialization:</label>
        <select id="specialization" name="specialization" required>
            <option value="">Select Specialization</option>
            {% for spec in specializations %}
                <option value="{{ spec }}">{{ spec }}</option>
            {% endfor %}
        </select>

        <!-- Doctor -->
        <label for="doctor">Doctor:</label>
        <select id="doctor" name="doctor_id" required>
            <option value="">Select Doctor</option>
        </select>

        <!-- Date -->
        <label for="date">Date:</label>
        <input type="date" id="date" name="date" required min="">

        <!-- Time -->
        <label for="time">Select Time Slot:</label>
        <select id="time" name="time" required>
            <option value="">Select a doctor & date first</option>
        </select>

        <button type="submit" class="btn">Confirm Booking</button>
    </form>
</div>

<!-- JavaScript -->
<script>
document.addEventListener("DOMContentLoaded", () => {
    console.log("ðŸ“… Booking Page Loaded");

    const specializationDropdown = document.getElementById("specialization");
    const doctorDropdown = document.getElementById("doctor");
    const dateInput = document.getElementById("date");
    const timeDropdown = document.getElementById("time");

    // Prevent selecting past dates
    const today = new Date().toISOString().split("T")[0];
    dateInput.setAttribute("min", today);

    // Load doctors when specialization changes
    specializationDropdown.addEventListener("change", () => {
        const specialization = specializationDropdown.value;
        doctorDropdown.innerHTML = "<option>Loading...</option>";

        fetch(`/get_doctors/${encodeURIComponent(specialization)}`)
            .then(res => res.json())
            .then(data => {
                doctorDropdown.innerHTML = '<option value="">Select Doctor</option>';
                if (data.length === 0) {
                    doctorDropdown.innerHTML = '<option disabled>No doctors available for this specialization</option>';
                    return;
                }
                data.forEach(doc => {
                    doctorDropdown.innerHTML += `<option value="${doc.doctor_id}">Dr. ${doc.name}</option>`;
                });
            })
            .catch(() => {
                doctorDropdown.innerHTML = '<option>Error loading doctors</option>';
            });
    });

    // Fetch and update available time slots
    function updateTimeSlots() {
        const doctorId = doctorDropdown.value;
        const date = dateInput.value;
        if (!doctorId || !date) {
            timeDropdown.innerHTML = '<option>Select doctor and date first</option>';
            return;
        }

        timeDropdown.innerHTML = '<option>Loading...</option>';

        fetch(`/get_available_slots/${doctorId}/${encodeURIComponent(date)}`)
            .then(res => res.json())
            .then(data => {
                const allSlots = [
                    "10:00 AM", "10:30 AM", "11:00 AM", "11:30 AM",
                    "12:00 PM", "12:30 PM",
                    "02:00 PM", "02:30 PM", "03:00 PM",
                    "03:30 PM", "04:00 PM", "04:30 PM", "05:00 PM"
                ];
                timeDropdown.innerHTML = "";

                if (data.booked.length === allSlots.length) {
                    timeDropdown.innerHTML = '<option disabled>All slots are booked for this day ðŸ˜ž</option>';
                    return;
                }

                allSlots.forEach(slot => {
                    const isBooked = data.booked.includes(slot);
                    const option = document.createElement("option");
                    option.value = slot;
                    option.textContent = slot;
                    if (isBooked) {
                        option.disabled = true;
                        option.style.color = "gray";
                    }
                    timeDropdown.appendChild(option);
                });
            })
            .catch(() => {
                timeDropdown.innerHTML = '<option>Error loading time slots</option>';
            });
    }

    // Update slots whenever doctor or date changes
    doctorDropdown.addEventListener("change", updateTimeSlots);
    dateInput.addEventListener("change", updateTimeSlots);
});
</script>

{% endblock %}
