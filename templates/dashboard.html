{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}
{% block content_class %}centered{% endblock %}
{% block content %}

<!-- Dashboard Container -->
<div class="dashboard-container" style="padding: 40px; text-align: center;">
    <h1 style="color: #0b2e59;">Welcome, {{ name }} üòä</h1>

    <!-- Appointments Section -->
    <section class="appointments-container">
        {% if appointments %}
            <p style="color: #444; width: 100%; text-align: center;">Here are your upcoming appointments.</p>

            {% for appointment in appointments %}
            <div class="appointment-card" id="appointment-{{ appointment['appointment_id'] }}">
                <h3>üìÖ {{ appointment['date'] }} ‚Äî {{ appointment['time'] }}</h3>
                <p>üë®‚Äç‚öïÔ∏è <b>Doctor:</b> {{ appointment['doctor_name'] }}</p>
                <p>üè• <b>Specialization:</b> {{ appointment['doctor_specialization'] }}</p>

                <button class="cancel-btn" data-id="{{ appointment['appointment_id'] }}">
                    Cancel
                </button>
            </div>
            {% endfor %}
        {% else %}
            <p style="font-size: 18px; color: #888; width: 100%; text-align: center;">
                üòû No appointments booked yet.
            </p>
        {% endif %}
    </section>

    <!-- Booking Section -->
    <div id="book-section" class="booking-container">
        <h2 style="color: #0b2e59;">Book a New Appointment</h2>
        <form method="POST" action="{{ url_for('dashboard') }}">
            
            <label for="specialization">Specialization:</label>
            <select id="specialization" name="specialization" required>
                <option value="">Select Specialization</option>
                {% for spec in specializations %}
                    <option value="{{ spec }}">{{ spec }}</option>
                {% endfor %}
            </select>

            <label for="doctor">Doctor:</label>
            <select id="doctor" name="doctor_id" required>
                <option value="">Select Doctor</option>
            </select>

            <label for="date">Date:</label>
            <input type="date" id="date" name="date" required min="">

            <label for="time">Select Time Slot:</label>
            <select id="time" name="time" required>
                <option value="">Select a doctor & date first</option>
            </select>

            <button type="submit" class="btn">Confirm Booking</button>
        </form>
    </div>
</div>

<!-- JavaScript -->
<script>
document.addEventListener("DOMContentLoaded", () => {
    // Smooth scroll if coming from navbar
    if (window.location.hash === "#book-section") {
        document.querySelector("#book-section").scrollIntoView({ behavior: "smooth" });
    }

    // --- Booking logic ---
    const specializationDropdown = document.getElementById("specialization");
    const doctorDropdown = document.getElementById("doctor");
    const dateInput = document.getElementById("date");
    const timeDropdown = document.getElementById("time");

    const today = new Date().toISOString().split("T")[0];
    dateInput.min = today;

    specializationDropdown.addEventListener("change", () => {
        const specialization = specializationDropdown.value;
        doctorDropdown.innerHTML = "<option>Loading...</option>";

        fetch(`/get_doctors/${encodeURIComponent(specialization)}`)
            .then(res => res.json())
            .then(data => {
                doctorDropdown.innerHTML = '<option value="">Select Doctor</option>';
                data.forEach(doc => {
                    doctorDropdown.innerHTML += `<option value="${doc.doctor_id}">Dr. ${doc.name}</option>`;
                });
            })
            .catch(() => doctorDropdown.innerHTML = '<option>Error loading doctors</option>');
    });

    function updateTimeSlots() {
        const doctorId = doctorDropdown.value;
        const date = dateInput.value;
        if (!doctorId || !date) {
            timeDropdown.innerHTML = '<option>Select doctor and date first</option>';
            return;
        }
        timeDropdown.innerHTML = '<option>Loading...</option>';

        fetch(`/get_available_slots/${doctorId}/${encodeURIComponent(date)}`)
            .then(res => res.json())
            .then(data => {
                const allSlots = [
                    "10:00 AM","10:30 AM","11:00 AM","11:30 AM",
                    "12:00 PM","12:30 PM",
                    "02:00 PM","02:30 PM","03:00 PM","03:30 PM",
                    "04:00 PM","04:30 PM","05:00 PM"
                ];
                timeDropdown.innerHTML = "";
                allSlots.forEach(slot => {
                    const option = document.createElement("option");
                    option.value = slot;
                    option.textContent = slot;
                    if (data.booked.includes(slot)) {
                        option.disabled = true;
                        option.style.color = "gray";
                    }
                    timeDropdown.appendChild(option);
                });
            })
            .catch(() => timeDropdown.innerHTML = '<option>Error loading time slots</option>');
    }

    doctorDropdown.addEventListener("change", updateTimeSlots);
    dateInput.addEventListener("change", updateTimeSlots);
});
</script>

{% endblock %}
